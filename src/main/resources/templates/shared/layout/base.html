<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Shoppie Food</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link rel="stylesheet" th:href="@{/css/base/color.css}">
        <link rel="stylesheet" th:href="@{/css/components/navbar.css}">
        <link rel="stylesheet" th:href="@{/css/components/sidebar.css}">
        <link rel="stylesheet" th:href="@{/css/components/cart.css}">
        <link rel="stylesheet" th:href="@{/css/components/products.css}">
        <link rel="stylesheet" th:href="@{/css/objects/auth.css}">
        <link rel="stylesheet" th:href="@{/css/objects/food.css}">
        <link rel="stylesheet" th:href="@{/css/objects/order.css}">
        <link rel="stylesheet" th:href="@{/css/objects/user.css}">
        <link rel="stylesheet" th:href="@{/css/misc.css}">
        <th:block layout:fragment="css"></th:block>
    </head>
    <body>
        <!-- Floating Sidebar -->
        <div id="floatingSidebar" class="floating-sidebar">
            <button id="sidebarCloseBtn" class="sidebar-close-btn">
                <img src="/images/icons/sidebar.png" alt="Sidebar" style="width: 32px; height: 32px; border: none !important; background: transparent !important;">
            </button>
            <div th:replace="~{shared/fragments/sidebar :: sidebar}"></div>            
        </div>
        
        <!-- Overlay for mobile -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
        
        <div class="content-wrapper">
            <div th:replace="~{shared/fragments/navbar :: navbar}"></div>
            <div class="main-content">
                <div layout:fragment="content"></div>
            </div>
        </div>

        <!-- Nhúng address-popup fragment -->
        <div th:replace="~{shared/fragments/address-popup :: address-popup}"></div>

        <!-- Script -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log("DOM fully loaded - initializing components");
                
                // Sidebar functionality
                const floatingSidebar = document.getElementById('floatingSidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
                const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
                
                // Thiết lập sự kiện cho nút mở sidebar
                if (sidebarToggleBtn) {
                    sidebarToggleBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        floatingSidebar.classList.add('active');
                        sidebarOverlay.classList.add('active');
                        document.body.style.overflow = 'hidden';
                    });
                }
                
                // Sự kiện đóng sidebar
                if (sidebarCloseBtn) {
                    sidebarCloseBtn.addEventListener('click', function() {
                        floatingSidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
                
                // Đóng sidebar khi nhấp vào overlay
                if (sidebarOverlay) {
                    sidebarOverlay.addEventListener('click', function() {
                        floatingSidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
                
                // Cart functionality
                const cartToggle = document.getElementById('cartToggle');
                const cartPopup = document.getElementById('cartPopup');
                const cartClose = document.getElementById('cartClose');
                const hideCartBtn = document.getElementById('hideCart');
                const cartOverlay = document.getElementById('cartOverlay');

                if (cartToggle && cartPopup) {
                    cartToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        cartPopup.classList.add('active');
                        cartOverlay.classList.add('active');
                        document.body.style.overflow = 'hidden'; // Prevent scrolling
                    });
                }

                if (cartClose) {
                    cartClose.addEventListener('click', function() {
                        cartPopup.classList.remove('active');
                        cartOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }

                if (hideCartBtn) {
                    hideCartBtn.addEventListener('click', function() {
                        cartPopup.classList.remove('active');
                        cartOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }

                if (cartOverlay) {
                    cartOverlay.addEventListener('click', function() {
                        cartPopup.classList.remove('active');
                        cartOverlay.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
                
                // Close popup when clicking outside
                document.addEventListener('click', function(e) {
                    if (cartPopup && cartPopup.classList.contains('active') && 
                        !cartPopup.contains(e.target) && 
                        !cartToggle.contains(e.target)) {
                        cartPopup.classList.remove('active');
                    }
                });

                // Prevent popup from closing when clicking inside
                if (cartPopup) {
                    cartPopup.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }

                // Xử lý nút đặt hàng
                const checkoutBtn = document.getElementById('checkoutBtn');
                const addressPopup = document.getElementById('addressPopup');
                const addressClose = document.getElementById('addressClose');
                const cancelAddress = document.getElementById('cancelAddress');
                
                if (checkoutBtn && addressPopup) {
                    checkoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation(); // Thêm dòng này
                        console.log("Checkout button clicked");
                        
                        // Đóng cart popup
                        if (cartPopup) cartPopup.classList.remove('active');
                        if (cartOverlay) cartOverlay.classList.remove('active');
                        
                        // Mở address popup
                        addressPopup.classList.add('active'); // Đảm bảo thêm class active
                        document.body.style.overflow = 'hidden';
                        
                        return false;
                    });
                }
                
                // Xử lý đóng popup địa chỉ
                if (addressClose) {
                    addressClose.addEventListener('click', function() {
                        addressPopup.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
                
                if (cancelAddress) {
                    cancelAddress.addEventListener('click', function() {
                        addressPopup.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }

                // Click bên ngoài để đóng popup (tùy chọn)
                addressPopup.addEventListener('click', function(e) {
                    if (e.target === addressPopup) {
                        addressPopup.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
                
                // Xử lý đóng popup bằng nút X
                const closePopupX = document.querySelector('.popup-header .popup-close-btn');
                if (closePopupX) {
                    closePopupX.addEventListener('click', function() {
                        addressPopup.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                }
                
                // Xử lý chọn địa chỉ
                const addressItems = document.querySelectorAll('.address-item');
                if (addressItems && addressItems.length > 0) {
                    addressItems.forEach(item => {
                        item.addEventListener('click', function() {
                            // Bỏ chọn tất cả các item
                            addressItems.forEach(i => i.classList.remove('selected'));
                            // Chọn item hiện tại
                            this.classList.add('selected');
                            // Chọn radio button tương ứng
                            const radio = this.querySelector('input[type="radio"]');
                            if (radio) radio.checked = true;
                        });
                    });
                }
                
                // Xử lý xác nhận đặt hàng
                const confirmAddress = document.getElementById('confirmAddress');
                if (confirmAddress) {
                    confirmAddress.addEventListener('click', function() {
                        // Lấy địa chỉ được chọn
                        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
                        const note = document.getElementById('note').value;
                        
                        if (selectedAddress) {
                            const addressId = selectedAddress.value;
                            const addressInfo = document.querySelector(`#address${addressId}`).closest('.address-item').querySelector('.address-text').textContent;
                            
                            console.log('Thông tin đặt hàng:', {
                                addressId,
                                addressInfo,
                                note,
                                cartItems,
                                totalAmount
                            });
                            
                            // Hiển thị thông báo đặt hàng thành công
                            showToast('Đặt hàng thành công! Cảm ơn bạn đã mua hàng.');
                            
                            // Đóng popup
                            addressPopup.classList.remove('active');
                            document.body.style.overflow = '';
                            
                            // Đóng giỏ hàng
                            if (cartPopup) {
                                cartPopup.classList.remove('active');
                            }
                            
                            // Xóa giỏ hàng
                            clearCart();
                        } else {
                            showToast('Vui lòng chọn địa chỉ giao hàng', 'error');
                        }
                    });
                }
                
                // Xử lý thêm địa chỉ mới
                const addAddressBtn = document.querySelector('.btn-add-address');
                if (addAddressBtn) {
                    addAddressBtn.addEventListener('click', function() {
                        showToast('Chức năng thêm địa chỉ mới sẽ được phát triển sau');
                    });
                }

                // Khởi tạo UI giỏ hàng
                updateCartTotal();
                updateCartUI();
            });
            
            // Dữ liệu giỏ hàng mẫu
            let cartItems = [
                {
                    id: 1,
                    name: 'Bún đậu mắm tôm',
                    price: 30000,
                    imageUrl: '/images/Food/bundau.png',
                    restaurantName: 'Nhà hàng Cá chà bặc',
                    quantity: 1
                },
                {
                    id: 2,
                    name: 'Bún măng gà',
                    price: 25000,
                    imageUrl: '/images/Food/bunmangga.png',
                    restaurantName: 'Lá chà bồn',
                    quantity: 3
                },
                {
                    id: 3,
                    name: 'Bún bò Huế',
                    price: 45000,
                    imageUrl: '/images/Food/bunbo.png',
                    restaurantName: 'Cam mười tú',
                    quantity: 2
                }
            ];

            let totalAmount = 0;

            // Xử lý đặt hàng và hiện popup chọn địa chỉ
            function handleCheckout() {
                console.log("Handle checkout called");
                
                // Lấy tham chiếu đến phần tử addressPopup
                const addressPopup = document.getElementById('addressPopup');
                
                // Kiểm tra xem phần tử có tồn tại không
                if (addressPopup) {
                    // Thêm class active để hiển thị popup
                    addressPopup.classList.add('active');
                    
                    // Chặn cuộn trang
                    document.body.style.overflow = 'hidden';
                    
                    console.log("Address popup activated with class:", addressPopup.className);
                } else {
                    console.error("Address popup element not found");
                }
                
                return false; // Ngăn chặn chuyển hướng trang
            }

            // Thêm sản phẩm vào giỏ hàng
            window.addToCart = function(foodId, name, price, imageUrl, restaurantName) {
                // Kiểm tra xem sản phẩm đã tồn tại chưa
                const existingItemIndex = cartItems.findIndex(item => item.id === foodId);
                
                if (existingItemIndex !== -1) {
                    // Nếu đã có, tăng số lượng
                    cartItems[existingItemIndex].quantity += 1;
                } else {
                    // Nếu chưa có, thêm mới
                    cartItems.push({
                        id: foodId,
                        name: name,
                        price: price,
                        imageUrl: imageUrl || "/images/food-placeholder.jpg",
                        restaurantName: restaurantName,
                        quantity: 1
                    });
                }
                
                // Cập nhật giỏ hàng
                updateCartTotal();
                updateCartUI();
                
                // Hiển thị popup giỏ hàng
                const cartPopup = document.getElementById('cartPopup');
                const cartOverlay = document.getElementById('cartOverlay');
                if (cartPopup && cartOverlay) {
                    cartPopup.classList.add('active');
                    cartOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                // Hiển thị thông báo
                showToast('Đã thêm sản phẩm vào giỏ hàng!');
                
                return false; // Ngăn chặn chuyển hướng trang
            }

            // Tăng số lượng sản phẩm
            function increaseQuantity(foodId) {
                const item = cartItems.find(item => item.id === foodId);
                if (item) {
                    item.quantity += 1;
                    updateCartTotal();
                    updateCartUI();
                }
                return false;
            }

            // Giảm số lượng sản phẩm
            function decreaseQuantity(foodId) {
                const index = cartItems.findIndex(item => item.id === foodId);
                if (index !== -1) {
                    if (cartItems[index].quantity > 1) {
                        cartItems[index].quantity -= 1;
                    } else {
                        // Nếu số lượng = 1, xóa khỏi giỏ hàng
                        cartItems.splice(index, 1);
                    }
                    updateCartTotal();
                    updateCartUI();
                }
                return false;
            }

            // Xóa sản phẩm khỏi giỏ hàng
            function removeFromCart(foodId) {
                cartItems = cartItems.filter(item => item.id !== foodId);
                updateCartTotal();
                updateCartUI();
                return false;
            }

            // Xóa toàn bộ giỏ hàng
            function clearCart() {
                cartItems = [];
                updateCartTotal();
                updateCartUI();
            }

            // Tính tổng tiền giỏ hàng
            function updateCartTotal() {
                totalAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            }

            // Cập nhật giao diện giỏ hàng
            function updateCartUI() {
                // Cập nhật số lượng sản phẩm hiển thị trên icon giỏ hàng
                const cartBadge = document.querySelector('.cart-badge');
                if (cartBadge) {
                    cartBadge.textContent = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                }
                
                // Cập nhật nội dung giỏ hàng
                const cartBody = document.querySelector('.cart-body');
                if (cartBody) {
                    if (cartItems.length === 0) {
                        // Hiển thị giỏ hàng trống
                        cartBody.innerHTML = `
                            <div class="empty-cart">
                                <svg class="empty-cart-icon" viewBox="0 0 24 24">
                                    <path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                                <p>Giỏ hàng của bạn đang trống</p>
                            </div>
                        `;
                    } else {
                        // Hiển thị sản phẩm trong giỏ hàng
                        let cartItemsHTML = '';
                        
                        // Thêm các sản phẩm thực tế từ cartItems
                        cartItems.forEach(item => {
                            cartItemsHTML += `
                                <div class="cart-item">
                                    <img src="${item.imageUrl}" alt="${item.name}" class="item-image">
                                    <div class="item-details">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-price">${formatCurrency(item.price)} VNĐ</div>
                                        <div class="item-restaurant">${item.restaurantName}</div>
                                    </div>
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="decreaseQuantity(${item.id})">-</button>
                                        <span class="quantity-display">${item.quantity}</span>
                                        <button class="quantity-btn" onclick="increaseQuantity(${item.id})">+</button>
                                    </div>
                                    <button class="remove-item-btn" onclick="removeFromCart(${item.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                        
                        // Thêm sản phẩm giả nếu cần để tạo scrollbar (chỉ để test)
                        // bỏ comment dòng dưới
                        for (let i = 0; i < 10; i++) {
                            cartItemsHTML += `
                                <div class="cart-item">
                                    <img src="/images/Food/bundau.png" alt="Test item ${i}" class="item-image">
                                    <div class="item-details">
                                        <div class="item-name">Test item ${i}</div>
                                        <div class="item-price">20,000 VNĐ</div>
                                        <div class="item-restaurant">Test restaurant</div>
                                    </div>
                                    <div class="quantity-controls">
                                        <button class="quantity-btn">-</button>
                                        <span class="quantity-display">1</span>
                                        <button class="quantity-btn">+</button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        cartBody.innerHTML = cartItemsHTML;
                    }
                }
                
                // Cập nhật phần footer giỏ hàng
                const cartFooter = document.querySelector('.cart-footer');
                if (cartFooter) {
                    if (cartItems.length === 0) {
                        cartFooter.style.display = 'none';
                    } else {
                        cartFooter.style.display = 'block';
                        const totalEl = cartFooter.querySelector('.cart-total span:last-child');
                        if (totalEl) {
                            totalEl.textContent = `${formatCurrency(totalAmount)} VNĐ`;
                        }
                    }
                }

                // Thêm lại sự kiện click cho nút đặt hàng sau khi cập nhật UI
                const checkoutBtn = document.getElementById('checkoutBtn');
                if (checkoutBtn) {
                    // Xóa tất cả event listener cũ
                    const newCheckoutBtn = checkoutBtn.cloneNode(true);
                    checkoutBtn.parentNode.replaceChild(newCheckoutBtn, checkoutBtn);
                    
                    // Thêm listener mới
                    newCheckoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("Checkout button clicked from updateCartUI");
                        
                        // Show address popup
                        const addressPopup = document.getElementById('addressPopup');
                        const cartPopup = document.getElementById('cartPopup');
                        const cartOverlay = document.getElementById('cartOverlay');
                        
                        if (addressPopup) {
                            addressPopup.classList.add('active');
                            if (cartPopup) cartPopup.classList.remove('active');
                            if (cartOverlay) cartOverlay.classList.remove('active');
                            document.body.style.overflow = 'hidden';
                        }
                        
                        return false;
                    });
                }
            }

            // Định dạng tiền tệ
            function formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN').format(amount);
            }

            // Hiển thị thông báo
            function showToast(message, type = 'success') {
                // Xóa toast cũ nếu có
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    document.body.removeChild(existingToast);
                }
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
        </script>
        <th:block layout:fragment="script"></th:block>
    </body>
</html>
