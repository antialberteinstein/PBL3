<!DOCTYPE html>
<html layout:decorate="~{shared/layout/base}">
<head layout:title="ƒêƒÉng K√Ω">
</head>
<div layout:fragment="content">
    <!-- Main content -->
    <div class="container-fluid register-container">
        
        <!-- Register form - now only one real form -->
        <div class="login-form">

            <form class="login-box" id="register-form" th:action="@{/auth/register}" method="post">
                <div class="login-title">ƒêƒÇNG K√ù</div>
                
                <div class="input-field">
                    <label for="phoneNumber" class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="required-star">*</span></label>
                    <input type="tel" class="form-control nform-control" id="phoneNumber" name="phoneNumber" required pattern="^(0|\+84)[0-9]{9}$">
                </div>
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (VD: 0901234567)</div>
                    <div class="valid-feedback">S·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá</div>
                </div>
                
                <div class="input-field">
                    <label for="email" class="form-label">Email <span class="required-star">*</span></label>
                    <input type="email" class="form-control nform-control" id="email" name="email" required>
                </div>
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email h·ª£p l·ªá</div>
                    <div class="valid-feedback">Email h·ª£p l·ªá</div>
                </div>
                
                <div class="input-field">
                    <label for="password" class="form-label">M·∫≠t Kh·∫©u <span class="required-star">*</span></label>
                    <div class="input-with-icon" style="flex: 1;">
                        <input type="password" class="form-control nform-control" id="password" name="password" required minlength="8">
                        <span class="toggle-password" onclick="togglePasswordVisibility('password')">üëÅÔ∏è</span>
                    </div>
                </div>
        
                <div class="input-field">
                    <label for="nothing" class="form-label"></label>
                    <div class="password-strength">
                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                    </div>
                </div>
                
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±</div>
                    <div class="password-feedback" id="passwordFeedback"></div>
                </div>
                
                <div class="input-field">
                    <label for="confirmPassword" class="form-label">Nh·∫≠p L·∫°i M·∫≠t Kh·∫©u <span class="required-star">*</span></label>
                    <div class="input-with-icon" style="flex: 1;">
                        <input type="password" class="form-control nform-control" id="confirmPassword" name="confirmPassword" required>
                        <span class="toggle-password" onclick="togglePasswordVisibility('confirmPassword')">üëÅÔ∏è</span>
                    </div>
                </div>
                
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">M·∫≠t kh·∫©u kh√¥ng kh·ªõp</div>
                    <div class="valid-feedback">M·∫≠t kh·∫©u kh·ªõp</div>
                </div>
                
                <div class="input-field">
                    <label for="name" class="form-label">H·ªç V√† T√™n <span class="required-star">*</span></label>
                    <input type="text" class="form-control nform-control" id="name" name="name" required>
                </div>
        
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">Vui l√≤ng nh·∫≠p t√™n ƒë·∫ßy ƒë·ªß</div>
                    <div class="valid-feedback">T√™n h·ª£p l·ªá</div>
                </div>
                
                <div class="input-field">
                    <label for="dateOfBirth" class="form-label">Ng√†y Sinh <span class="required-star">*</span></label>
                    <input type="date" class="form-control nform-control" id="dateOfBirth" name="dateOfBirth" required>
                </div>
        
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">Vui l√≤ng ch·ªçn ng√†y sinh</div>
                    <div class="valid-feedback">Ng√†y sinh h·ª£p l·ªá</div>
                </div>
                
                <div class="input-field">
                    <label for="gender" class="form-label">Gi·ªõi T√≠nh <span class="required-star">*</span></label>
                    <select class="form-control nform-control" id="gender" name="gender" required>
                        <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
        
                <div class="feedback-container mb-2">
                    <div class="invalid-feedback">Vui l√≤ng ch·ªçn gi·ªõi t√≠nh</div>
                </div>
        
                <div class="mb-3" style="margin-left: 160px; margin-top: 10px;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsCheck" name="termsCheck" required>
                        <label class="form-check-label" for="termsCheck">
                            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a>
                        </label>
                    </div>
                </div>
        
                <div class="feedback-container">
                    <div class="invalid-feedback">B·∫°n ph·∫£i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n d·ªãch v·ª•</div>
                </div>
        
                <div class="d-flex justify-content-between">
                    <a href="/auth/login" class="btn btn-secondary nbtn-secondary">ƒêƒÉng Nh·∫≠p</a>
                    <button type="submit" class="btn btn-primary nbtn-primary" id="registerBtn">ƒêƒÉng K√Ω</button>
                </div>
                <p id="formMessage" class="text-danger mt-3 text-center" th:text="${message}"></p>
            </form>  
        </div>
        <div class="left-img">
            <img src="/images/chef.png" alt="Registration" />
        </div>
    </div>
    
    <!-- Terms Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Terms content here -->
                    <p>ƒê√¢y l√† ƒëi·ªÅu kho·∫£n d·ªãch v·ª• c·ªßa ch√∫ng t√¥i. Vui l√≤ng ƒë·ªçc k·ªπ tr∆∞·ªõc khi ƒëƒÉng k√Ω.</p>
                    <!-- Add your terms content here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn nbtn-primary" data-bs-dismiss="modal">ƒê·ªìng √Ω</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="misc">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById("register-form");
            const formMessage = document.getElementById("formMessage");
            const passwordInput = document.getElementById("password");
            const confirmPasswordInput = document.getElementById("confirmPassword");
            const strengthBar = document.getElementById("passwordStrengthBar");
            const passwordFeedback = document.getElementById("passwordFeedback");
            
            // Function to validate email format
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            // Function to validate phone number format
            function isValidPhone(phone) {
                const phoneRegex = /^(0|\+84)[0-9]{9}$/;
                return phoneRegex.test(phone);
            }
            
            // Function to validate name (not empty)
            function isValidName(name) {
                return name.trim().length > 0;
            }
            
            // Function to validate date of birth (not empty)
            function isValidDateOfBirth(dob) {
                return dob.trim().length > 0;
            }
            
            // Function to validate gender (selected)
            function isValidGender(gender) {
                return gender.trim().length > 0;
            }
            
            // Real-time validation for phone number
            const phoneNumberInput = document.getElementById("phoneNumber");
            phoneNumberInput.addEventListener('input', function() {
                validateField(phoneNumberInput, isValidPhone(phoneNumberInput.value));
            });
            
            // Real-time validation for email
            const emailInput = document.getElementById("email");
            emailInput.addEventListener('input', function() {
                validateField(emailInput, isValidEmail(emailInput.value));
            });
            
            // Real-time validation for name
            const nameInput = document.getElementById("name");
            nameInput.addEventListener('input', function() {
                validateField(nameInput, isValidName(nameInput.value));
            });
            
            // Real-time validation for date of birth
            const dobInput = document.getElementById("dateOfBirth");
            dobInput.addEventListener('change', function() {
                validateField(dobInput, isValidDateOfBirth(dobInput.value));
            });
            
            // Real-time validation for gender
            const genderInput = document.getElementById("gender");
            genderInput.addEventListener('change', function() {
                validateField(genderInput, isValidGender(genderInput.value));
            });
            
            // Password strength meter
            passwordInput.addEventListener('input', function() {
                const password = passwordInput.value;
                const strength = calculatePasswordStrength(password);
                
                // Update strength bar
                strengthBar.style.width = `${strength.score * 25}%`;
                strengthBar.className = 'password-strength-bar';
                
                if (password.length < 8) {
                    // Invalid password length
                    validateField(passwordInput, false);
                } else {
                    // Valid password length, remove invalid state
                    passwordInput.classList.remove("is-invalid");
                    
                    // But don't mark as valid until it's strong enough
                    if (strength.score >= 3) {
                        passwordInput.classList.add("field-valid");
                    } else {
                        passwordInput.classList.remove("field-valid");
                    }
                }
                
                // Update strength indicator
                if (strength.score === 0) {
                    strengthBar.classList.add('weak');
                    passwordFeedback.textContent = 'M·∫≠t kh·∫©u qu√° y·∫øu';
                    passwordFeedback.className = 'password-feedback text-danger';
                } else if (strength.score < 3) {
                    strengthBar.classList.add('medium');
                    passwordFeedback.textContent = strength.feedback;
                    passwordFeedback.className = 'password-feedback text-warning';
                } else {
                    strengthBar.classList.add('strong');
                    passwordFeedback.textContent = 'M·∫≠t kh·∫©u m·∫°nh';
                    passwordFeedback.className = 'password-feedback text-success';
                }
                
                // If confirm password is already filled, check match
                if (confirmPasswordInput.value) {
                    validateConfirmPassword();
                }
            });
            
            // Confirm password validation
            confirmPasswordInput.addEventListener('input', validateConfirmPassword);
            
            function validateConfirmPassword() {
                const isMatch = passwordInput.value === confirmPasswordInput.value;
                validateField(confirmPasswordInput, isMatch && confirmPasswordInput.value.length > 0);
            }
            
            // Terms checkbox validation
            const termsCheck = document.getElementById("termsCheck");
            termsCheck.addEventListener('change', function() {
                if (termsCheck.checked) {
                    termsCheck.classList.remove("is-invalid");
                    // T√¨m feedback-container g·∫ßn nh·∫•t sau checkbox
                    const feedbackContainer = termsCheck.closest('.form-check').parentElement.nextElementSibling;
                    if (feedbackContainer && feedbackContainer.classList.contains('feedback-container')) {
                        feedbackContainer.querySelector('.invalid-feedback').style.display = 'none';
                    }
                }
            });
            
            // Generic field validation function
            function validateField(field, isValid) {
                if (isValid) {
                    field.classList.remove("is-invalid");
                    field.classList.add("field-valid");
                    
                    // T√¨m feedback-container g·∫ßn nh·∫•t sau field
                    const feedbackContainer = field.closest('.input-field').nextElementSibling;
                    if (feedbackContainer && feedbackContainer.classList.contains('feedback-container')) {
                        feedbackContainer.querySelector('.invalid-feedback').style.display = 'none';
                        feedbackContainer.querySelector('.valid-feedback').style.display = 'block';
                    }
                } else {
                    field.classList.remove("field-valid");
                    if (field.value) {
                        field.classList.add("is-invalid");
                        
                        // T√¨m feedback-container g·∫ßn nh·∫•t sau field
                        const feedbackContainer = field.closest('.input-field').nextElementSibling;
                        if (feedbackContainer && feedbackContainer.classList.contains('feedback-container')) {
                            feedbackContainer.querySelector('.invalid-feedback').style.display = 'block';
                            feedbackContainer.querySelector('.valid-feedback').style.display = 'none';
                        }
                    } else {
                        field.classList.remove("is-invalid");
                        
                        // T√¨m feedback-container g·∫ßn nh·∫•t sau field
                        const feedbackContainer = field.closest('.input-field').nextElementSibling;
                        if (feedbackContainer && feedbackContainer.classList.contains('feedback-container')) {
                            feedbackContainer.querySelector('.invalid-feedback').style.display = 'none';
                            feedbackContainer.querySelector('.valid-feedback').style.display = 'none';
                        }
                    }
                }
            }
            
            // Form submission
            registerForm.addEventListener("submit", function(event) {
                event.preventDefault();
                
                const phoneNumber = phoneNumberInput.value;
                const email = emailInput.value;
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                const name = nameInput.value;
                const dateOfBirth = dobInput.value;
                const gender = genderInput.value;
                
                // Reset validation state
                resetValidationState();
                
                // Validate form
                let isValid = true;
                
                // Check required fields
                if (!isValidPhone(phoneNumber)) {
                    validateField(phoneNumberInput, false);
                    isValid = false;
                }
                
                if (!isValidEmail(email)) {
                    validateField(emailInput, false);
                    isValid = false;
                }
                
                if (password.length < 8) {
                    validateField(passwordInput, false);
                    isValid = false;
                }
                
                if (password !== confirmPassword) {
                    validateField(confirmPasswordInput, false);
                    formMessage.textContent = "Nh·∫≠p l·∫°i m·∫≠t kh·∫©u kh√¥ng kh·ªõp";
                    isValid = false;
                }
                
                if (!isValidName(name)) {
                    validateField(nameInput, false);
                    isValid = false;
                }
                
                if (!isValidDateOfBirth(dateOfBirth)) {
                    validateField(dobInput, false);
                    isValid = false;
                }
                
                if (!isValidGender(gender)) {
                    validateField(genderInput, false);
                    isValid = false;
                }
                
                if (!termsCheck.checked) {
                    termsCheck.classList.add("is-invalid");
                    // Hi·ªÉn th·ªã feedback cho checkbox
                    const feedbackContainer = termsCheck.closest('.form-check').parentElement.nextElementSibling;
                    if (feedbackContainer && feedbackContainer.classList.contains('feedback-container')) {
                        feedbackContainer.querySelector('.invalid-feedback').style.display = 'block';
                    }
                    formMessage.textContent = "B·∫°n ph·∫£i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n d·ªãch v·ª•";
                    isValid = false;
                }
                
                if (!isValid) {
                    return;
                }
                
                // Disable the submit button to prevent double submission
                document.getElementById("registerBtn").disabled = true;
                
                // Submit the form
                this.submit();
            });
            
            // Reset validation state
            function resetValidationState() {
                formMessage.textContent = "";
                const invalidFields = document.querySelectorAll(".is-invalid");
                invalidFields.forEach(field => field.classList.remove("is-invalid"));
                
                // ·∫®n t·∫•t c·∫£ c√°c feedback
                document.querySelectorAll('.invalid-feedback, .valid-feedback').forEach(feedback => {
                    feedback.style.display = 'none';
                });
            }
            
            // Calculate password strength
            function calculatePasswordStrength(password) {
                if (!password) {
                    return { score: 0, feedback: "M·∫≠t kh·∫©u qu√° y·∫øu" };
                }
                
                let score = 0;
                let feedback = "";
                
                // Length check
                if (password.length >= 8) {
                    score += 1;
                } else {
                    feedback = "M·∫≠t kh·∫©u n√™n c√≥ √≠t nh·∫•t 8 k√Ω t·ª±";
                    return { score, feedback };
                }
                
                // Complexity checks
                const hasLower = /[a-z]/.test(password);
                const hasUpper = /[A-Z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                const hasSpecial = /[^a-zA-Z0-9]/.test(password);
                
                // Score based on complexity
                if (hasLower) score += 0.5;
                if (hasUpper) score += 0.5;
                if (hasNumber) score += 1;
                if (hasSpecial) score += 1;
                
                // Feedback based on missing complexity
                if (score < 4) {
                    feedback = "N√™n bao g·ªìm ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát";
                    if (!hasLower || !hasUpper) feedback += ": ch·ªØ hoa v√† th∆∞·ªùng";
                    if (!hasNumber) feedback += ", s·ªë";
                    if (!hasSpecial) feedback += ", k√Ω t·ª± ƒë·∫∑c bi·ªát";
                }
                
                return { score, feedback };
            }
        });

        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
        }
    </script>
</div>
</html>